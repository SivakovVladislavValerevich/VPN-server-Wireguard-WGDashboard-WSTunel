# Пошаговое руководство по установке WGDashboard для WireGuard

## Содержание

1. [Обзор](#обзор)
2. [Требования](#требования)
3. [Настройка файрвола iptables](#настройка-файрвола-iptables)
4. [Установка WGDashboard](#установка-wgdashboard)
5. [Запуск и первичная настройка](#запуск-и-первичная-настройка)
6. [Определение IP-адреса и состояния работы сервиса](#определение-ip-адреса-и-состояния-работы-сервиса)
7. [Настройка автозапуска](#настройка-автозапуска)
8. [Управление сервисом](#управление-сервисом)
9. [Доступ к панели управления](#доступ-к-панели-управления)
10. [Устранение ошибок](#устранение-ошибок)
11. [Быстрая установка](#быстрая-установка)

## Обзор

WGDashboard - это веб-панель для управления WireGuard VPN-сервером. Она позволяет легко создавать, удалять и управлять конфигурациями и пользователями через веб-интерфейс.

## Требования

- Debian/Ubuntu или другой Linux-дистрибутив
- Python 3.7 или выше
- Git
- Права администратора (root)
- Выполнение предварительных шагов из [Руководства по подготовке сервера к установкам и настройкам](0README_Preparing_the_server_for_installation_and_configuration.md) и [Руководства по настройке файрвола](2README_Configuring_The_Firewall.md)

> **Примечание**: Подготовка системы, обновление и установка необходимых пакетов описаны в [Руководстве по подготовке сервера к установкам и настройкам](0README_Preparing_the_server_for_installation_and_configuration.md). Настройка файрвола для дальнейшей работы и открытие необходимых портов описаны в [Руководстве по настройке файрвола](2README_Configuring_The_Firewall.md). Пожалуйста, выполните эти шаги перед продолжением установки WGDashboard.

### Шаг 1: Проверка Python

```bash
python3 -V
```

> **Примечание:** Команда отображает версию установленного Python. Флаг `-V` (заглавная V) запрашивает версию интерпретатора. WGDashboard требует Python версии 3.7 или выше, поэтому важно убедиться, что ваша система соответствует этому требованию. В случае отсутствия подходящей версии, вам может потребоваться установить или обновить Python.

### Шаг 2: Включение IP-форвардинга и настройка файрвола

Для корректной работы необходимо настроить IP-форвардинг и файрвол. Подробные инструкции по настройке файрвола для WireGuard, WGDashboard и других компонентов системы содержатся в отдельном [Руководстве по настройке файрвола](2README_Configuring_The_Firewall.md).

> **Важно:** не забудьте разрешить доступ к порту 10086, используемому веб-интерфейсом WGDashboard.

## Установка WGDashboard

### Шаг 1: Клонирование репозитория

```bash
cd ~
git clone https://github.com/donaldzou/WGDashboard.git
```

> **Примечание:** Первая команда `cd ~` переходит в домашнюю директорию пользователя. Вторая команда `git clone` скачивает исходный код WGDashboard с GitHub-репозитория. Этот процесс создаст локальную копию всего проекта в новой директории `WGDashboard` в вашей домашней директории. Клонирование репозитория позволяет получить самую свежую версию веб-панели управления.

### Шаг 2: Настройка прав

```bash
cd WGDashboard/src
chmod +x ./wgd.sh
sudo chmod -R 755 /etc/wireguard
```

> **Примечание:** Эти команды настраивают необходимые права доступа:
> - `cd WGDashboard/src` переходит в директорию с исходным кодом проекта
> - `chmod +x ./wgd.sh` делает скрипт установки и управления WGDashboard исполняемым
> - `sudo chmod -R 755 /etc/wireguard` рекурсивно (-R) устанавливает права 755 на директорию WireGuard, что дает владельцу полные права (7=4+2+1), а группе и остальным - права на чтение и выполнение (5=4+1). Эти права необходимы для работы веб-интерфейса с конфигурационными файлами WireGuard.

### Шаг 3: Запуск установщика

```bash
./wgd.sh install
```

> **Примечание:** Эта команда запускает установочный скрипт WGDashboard. В процессе установки скрипт выполнит следующие действия:
> - Создаст необходимые директории для хранения данных
> - Настроит виртуальное окружение Python (venv)
> - Установит все необходимые зависимости через pip
> - Запросит выбор зеркала для загрузки пакетов (можно просто нажать Enter для выбора по умолчанию)
> - Настроит базовую конфигурацию
>
> Установка может занять несколько минут в зависимости от скорости вашего интернет-соединения и производительности сервера.

>Во время установки скрипт:
>- Создаст необходимые директории
>- Проверит наличие Python
>- Предложит выбрать зеркало для загрузки пакетов Python (можно нажать Enter для использования по умолчанию)
>- Установит виртуальное окружение и зависимости

## Запуск и первичная настройка

### Шаг 1: Запуск WGDashboard

После успешной установки запустите WGDashboard:

```bash
./wgd.sh start
```

> **Примечание:** Команда запускает WGDashboard в фоновом режиме. Скрипт активирует виртуальное окружение Python и запускает веб-сервер Gunicorn, который начнет прослушивать порт 10086. После выполнения команды веб-интерфейс станет доступен по адресу http://ваш_ip:10086, где вы сможете создать учетную запись администратора при первом входе.

### Шаг 2: Проверка работы WGDashboard

Убедитесь, что сервис запущен:

```bash
ps aux | grep dashboard.py
```

> **Примечание:** Команда проверяет, запущен ли процесс WGDashboard. Она использует `ps aux` для вывода списка всех запущенных процессов и `grep dashboard.py` для фильтрации только тех, которые связаны с WGDashboard. Если процесс запущен, вы увидите строку с процессом Python, запускающим dashboard.py. Если результат пустой или показывает только сам процесс grep, значит WGDashboard не запущен.

Проверьте, что порт открыт:

```bash
netstat -tuln | grep 10086
```

> **Примечание:** Эта команда проверяет, прослушивается ли порт 10086:
> - `netstat -tuln` показывает все TCP (-t) и UDP (-u) соединения в режиме прослушивания (-l) с числовыми адресами (-n)
> - `grep 10086` фильтрует результат, показывая только строки, содержащие порт 10086
> 
> Если порт прослушивается, вы увидите строку вида `tcp 0 0 0.0.0.0:10086 0.0.0.0:* LISTEN`, что указывает на то, что веб-сервер успешно запущен и ожидает подключений.

## Определение IP-адреса и состояния работы сервиса

Чтобы определить IP-адреса и состояние работы сервиса, на котором работает WGDashboard, выполните команду:

```bash
ifconfig
```

> **Примечание:** Команда `ifconfig` отображает информацию о сетевых интерфейсах вашего сервера, включая их IP-адреса, MAC-адреса, статистику пакетов и другие параметры. Она помогает определить публичный или локальный IP-адрес вашего сервера, который нужен для доступа к веб-панели WGDashboard через браузер по адресу http://ваш_ip:10086.

Пример вывода:

```
eth0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet ваш_ip  netmask 255.255.255.0  broadcast ip
        ether fa:16:3e:be:40:58  txqueuelen 1000  (Ethernet)
        RX packets 0  bytes 0 (0.0 B)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 0  bytes 0 (0.0 B)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

lo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536
        inet ip  netmask 255.0.0.0
        inet6 ::1  prefixlen 128  scopeid 0x10<host>
        loop  txqueuelen 1000  (Local Loopback)
        RX packets 0  bytes 0 (0.0 B)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 0  bytes 0 (0.0 B)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
```

>Ищите строку `inet` в разделе вашего основного сетевого интерфейса (обычно `eth0`). В данном примере IP-адрес `ваш_ip`:10086 - адрес веб панели. 

Если команда `ifconfig` не найдена, установите пакет `net-tools` или используйте альтернативную команду:

```bash
ip a
```

> **Примечание:** Команда `ip a` (сокращение от `ip address show`) - это современная альтернатива команде `ifconfig` из пакета iproute2. Она выводит аналогичную информацию о сетевых интерфейсах, но имеет немного другой формат вывода. Если команда `ifconfig` недоступна, это означает, что пакет `net-tools` не установлен в системе. `ip a` показывает ту же информацию о сетевых интерфейсах, включая IP-адреса, необходимые для доступа к веб-панели WGDashboard.

## Настройка автозапуска

### Шаг 1: Получение абсолютного пути к директории

Перед созданием службы systemd определите абсолютный путь к директории WGDashboard:

```bash
echo $HOME/WGDashboard/src
```

> **Примечание:** Эта команда выводит абсолютный путь к директории `WGDashboard/src` относительно вашей домашней директории (`$HOME`). Systemd требует указания абсолютных путей в файлах конфигурации служб, поэтому важно получить точный путь. Результат этой команды (например, `/root/WGDashboard/src` или `/home/username/WGDashboard/src`) нужно будет использовать в следующем шаге при создании файла службы systemd.

Для пользователя root обычно это `/root/WGDashboard/src`.

### Шаг 2: Создание файла службы

```bash
sudo nano /etc/systemd/system/wg-dashboard.service
```

### Шаг 3: Добавление конфигурации

Вставьте следующий код (используя абсолютные пути):

```ini
[Unit]
After=syslog.target network-online.target
Wants=wg-quick.target
ConditionPathIsDirectory=/etc/wireguard

[Service]
Type=forking
PIDFile=/root/WGDashboard/src/gunicorn.pid
WorkingDirectory=/root/WGDashboard/src
ExecStart=/root/WGDashboard/src/wgd.sh start
ExecStop=/root/WGDashboard/src/wgd.sh stop
ExecReload=/root/WGDashboard/src/wgd.sh restart
TimeoutSec=120
PrivateTmp=yes
Restart=always

[Install]
WantedBy=multi-user.target
```

>⚠️ **ВАЖНО:** Замените пути `/root/WGDashboard/src` на правильный абсолютный путь для вашей системы. Systemd не поддерживает использование тильды (~) для обозначения домашней директории.

### Шаг 4: Настройка прав и активация службы

```bash
sudo chmod 664 /etc/systemd/system/wg-dashboard.service
sudo systemctl daemon-reload
sudo systemctl enable wg-dashboard.service
sudo systemctl start wg-dashboard.service
```

### Шаг 5: Проверка статуса

```bash
sudo systemctl status wg-dashboard.service
```

>**ВАЖНО:** остальные действия ниже - для справки!

## Управление сервисом

Вы можете управлять WGDashboard следующими командами:

```bash
cd ~/WGDashboard/src

# Запустить в фоновом режиме
./wgd.sh start

# Запустить в режиме отладки (на переднем плане)
./wgd.sh debug

# Остановить сервис
./wgd.sh stop

# Перезапустить сервис
./wgd.sh restart
```

## Доступ к панели управления

После успешной установки и запуска, WGDashboard будет доступен по адресу:

```
http://ваш_ip:10086
```

Используйте IP-адрес, полученный из команды `ifconfig` выше.

## Устранение ошибок

### Ошибки при настройке автозапуска

Если вы получаете ошибку вида `Unit has a bad unit file setting` или `path is not absolute`, убедитесь, что в файле службы systemd используются только абсолютные пути, а не относительные с тильдой (~).

Исправьте пути в файле службы:

```bash
sudo nano /etc/systemd/system/wg-dashboard.service
```

И замените все строки, содержащие `~/WGDashboard/src` на абсолютный путь, например: `/root/WGDashboard/src` или `/home/your_username/WGDashboard/src`.

### Ошибки при установке зависимостей Python

Если при установке возникли проблемы с Python-зависимостями, запустите отладку:

```bash
./wgd.sh debug
```

Затем установите недостающие модули:

```bash
pip install Flask     # замените Flask на отсутствующий модуль
```

Для установки в систему, а не в виртуальное окружение (не рекомендуется):

```bash
pip install flask ifcfg icmplib --break-system-packages
```

### Порт 10086 занят

Если порт 10086 уже занят, вам нужно остановить сервис, занимающий этот порт, или изменить порт WGDashboard:

```bash
sudo lsof -i :10086  # проверить, какой процесс использует порт
sudo kill <PID>      # остановить процесс
```

### Проблемы с файрволом

Если вы не можете подключиться к веб-интерфейсу, проверьте правила файрвола:

```bash
sudo iptables -L -v
```

Временно разрешите весь входящий трафик, чтобы проверить, связана ли проблема с файрволом:

```bash
sudo iptables -P INPUT ACCEPT
```

Если после этого сервис стал доступен, значит проблема в правилах iptables. Добавьте нужные правила и сохраните их:

```bash
sudo iptables -A INPUT -p tcp --dport 10086 -j ACCEPT
sudo netfilter-persistent save
```

### Проверка WireGuard

Проверьте статус интерфейсов WireGuard:

```bash
sudo wg
sudo wg show
```

### Логи WGDashboard

Логи WGDashboard хранятся в директории `src/log`. Проверьте их при возникновении проблем:

```bash
cat ~/WGDashboard/src/log/access_*.log  # логи доступа
cat ~/WGDashboard/src/log/error_*.log   # логи ошибок
```

## Быстрая установка

Если вы хотите быстро установить WGDashboard одной командой, выполните:

```bash
## Быстрая установка
git clone https://github.com/donaldzou/WGDashboard.git && \
cd ./WGDashboard/src && \
chmod +x ./wgd.sh && \
./wgd.sh install && \
sudo echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf && \
sudo sysctl -p /etc/sysctl.conf && \
./wgd.sh start
``` 