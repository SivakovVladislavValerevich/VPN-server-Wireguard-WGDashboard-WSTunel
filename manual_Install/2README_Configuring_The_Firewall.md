# Руководство по настройке файрвола для WireGuard и сопутствующих сервисов

## Содержание

1. [Обзор](#обзор)
2. [Базовые настройки](#базовые-настройки)
   - [Установка iptables](#установка-iptables)
   - [Настройка IP-форвардинга](#настройка-ip-форвардинга)
   - [Базовые правила файрвола](#базовые-правила-файрвола)
3. [Настройка для WireGuard](#настройка-для-wireguard)
4. [Настройка для WGDashboard](#настройка-для-wgdashboard)
5. [Настройка для Wstunnel](#настройка-для-wstunnel)
6. [Дополнительные настройки и советы](#дополнительные-настройки-и-советы)
7. [Управление правилами файрвола](#управление-правилами-файрвола)

## Обзор

Данный документ описывает шаги, необходимые для правильной настройки файрвола. Эти шаги являются общими для всех последующих руководств и должны быть выполнены. Правильная настройка файрвола является критически важной для безопасности и корректной работы VPN-сервера. Этот документ описывает настройку файрвола iptables для WireGuard, веб-панели WGDashboard и обфускации Wstunnel.

## Базовые настройки

### Установка iptables

```bash
sudo apt install iptables iptables-persistent -y
```

> **Примечание:** Эта команда устанавливает пакеты `iptables` (программа для настройки правил сетевого экрана) и `iptables-persistent` (утилита для сохранения правил файрвола между перезагрузками). Флаг `-y` автоматически отвечает "да" на все запросы во время установки. Пакет `iptables-persistent` создаст файлы `/etc/iptables/rules.v4` и `/etc/iptables/rules.v6`, в которых будут сохраняться настройки файрвола для IPv4 и IPv6.

После установки iptables-persistent вам будет предложено сохранить текущие правила IPv4 и IPv6, выберите "Да" для обоих запросов.

### Настройка IP-форвардинга

IP-форвардинг необходим для работы VPN-сервера, чтобы пересылать пакеты между клиентами и интернетом.

```bash
sudo echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
sudo sysctl -p /etc/sysctl.conf
```

> **Примечание:** Первая команда добавляет параметр `net.ipv4.ip_forward=1` в файл конфигурации системных параметров `/etc/sysctl.conf`, что включает пересылку IP-пакетов между сетевыми интерфейсами (необходимо для работы VPN). Вторая команда `sysctl -p` применяет эти изменения немедленно, без перезагрузки системы. IP-форвардинг позволяет серверу выступать в роли маршрутизатора, передавая трафик между вашей VPN-сетью и интернетом.

### Базовые правила файрвола

Следующие команды настраивают базовые правила файрвола для безопасности сервера:

```bash
# Очистка текущих правил
sudo iptables -F
sudo iptables -X

# Установка политик по умолчанию
sudo iptables -P INPUT DROP
sudo iptables -P FORWARD DROP
sudo iptables -P OUTPUT ACCEPT

# Разрешить локальный интерфейс
sudo iptables -A INPUT -i lo -j ACCEPT

# Разрешить установленные соединения
sudo iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
sudo iptables -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT

# Разрешить SSH (чтобы не потерять доступ к серверу)
sudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT

# Разрешить пинги (опционально)
sudo iptables -A INPUT -p icmp --icmp-type echo-request -j ACCEPT
```

> **Примечание:** 
> - `iptables -F` и `iptables -X` очищают все существующие правила и удаляют пользовательские цепочки правил
> - `iptables -P INPUT DROP` устанавливает политику по умолчанию "DROP" (отбрасывать) для входящих пакетов, что блокирует весь входящий трафик, кроме явно разрешенного
> - `iptables -P FORWARD DROP` блокирует перенаправление трафика между интерфейсами
> - `iptables -P OUTPUT ACCEPT` разрешает весь исходящий трафик с сервера
> - `iptables -A INPUT -i lo -j ACCEPT` разрешает весь трафик на локальном интерфейсе (необходим для работы многих программ)
> - `iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT` разрешает входящие пакеты, которые являются частью уже установленных соединений
> - `iptables -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT` разрешает перенаправление пакетов для установленных соединений
> - `iptables -A INPUT -p tcp --dport 22 -j ACCEPT` разрешает входящие подключения по SSH (порт 22), чтобы сохранить доступ к серверу
> - `iptables -A INPUT -p icmp --icmp-type echo-request -j ACCEPT` разрешает ICMP-запросы (пинги) к серверу

## Настройка для WireGuard

### Основные правила для WireGuard

```bash
# Разрешить WireGuard порт (замените 20820 на ваш порт, если используете другой)
sudo iptables -A INPUT -p udp --dport 20820 -j ACCEPT

# Настройка NAT и форвардинга для WireGuard
sudo iptables -A FORWARD -i wg0 -j ACCEPT
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```

> **Примечание:**
> - `iptables -A INPUT -p udp --dport 20820 -j ACCEPT` разрешает входящие UDP-подключения на порт 20820, который использует WireGuard (замените порт на ваш, если он отличается)
> - `iptables -A FORWARD -i wg0 -j ACCEPT` разрешает перенаправление трафика, поступающего через интерфейс WireGuard (wg0)
> - `iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE` настраивает NAT (Network Address Translation), чтобы трафик от VPN-клиентов выходил в интернет с IP-адресом сервера. Это скрывает внутренние адреса VPN-сети (10.0.0.0/24) за внешним IP вашего сервера.

> **Важно:** Если вы используете другое имя сетевого интерфейса (не eth0), замените его в правилах выше.

### Автоматические правила через конфигурацию WireGuard

В конфигурационном файле `/etc/wireguard/wg0.conf` можно добавить автоматическое применение правил при запуске/остановке интерфейса:

```
[Interface]
# Другие настройки...
PostUp = iptables -A FORWARD -i %i -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
PostDown = iptables -D FORWARD -i %i -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE
```

> **Примечание:** Эти параметры в конфигурации WireGuard автоматически выполняют команды после запуска (`PostUp`) и при остановке (`PostDown`) интерфейса. `%i` — это переменная, которая заменяется на имя интерфейса (wg0). Таким образом, вам не нужно вручную настраивать правила iptables каждый раз при запуске/остановке WireGuard, это происходит автоматически. Команды `PostUp` добавляют правила маршрутизации, а `PostDown` удаляют их при отключении VPN.

## Настройка для WGDashboard

```bash
# Разрешить порт WGDashboard веб-интерфейса
sudo iptables -A INPUT -p tcp --dport 10086 -j ACCEPT
```

> **Примечание:** Команда разрешает входящие TCP-подключения на порт 10086, используемый веб-панелью WGDashboard. После добавления этого правила вы сможете получить доступ к WGDashboard по адресу http://ваш_ip_адрес:10086 с любого устройства, имеющего сетевой доступ к серверу.

### Безопасный доступ к WGDashboard (опционально)

Если вы хотите разрешить доступ только с определенного IP-адреса:

```bash
# Удалите общее правило, если оно было добавлено
sudo iptables -D INPUT -p tcp --dport 10086 -j ACCEPT

# Добавьте правило с ограничением по IP
sudo iptables -A INPUT -p tcp --dport 10086 -s ваш_ip -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 10086 -j DROP
```

> **Примечание:** Эти правила обеспечивают дополнительную безопасность для веб-интерфейса WGDashboard:
> - Первая команда удаляет предыдущее правило, разрешающее доступ всем
> - Вторая команда разрешает подключения к порту 10086 только с указанного IP-адреса (замените `ваш_ip` на реальный IP, с которого вы будете обращаться к панели)
> - Третья команда блокирует все остальные попытки доступа к этому порту
>
> Такой подход значительно повышает безопасность вашей панели управления WGDashboard, защищая её от несанкционированного доступа и возможных попыток взлома.

## Настройка для Wstunnel

```bash
# Разрешить WStunel порт (обычно 443 для обфускации через HTTP/HTTPS)
sudo iptables -A INPUT -p tcp --dport 443 -j ACCEPT
sudo iptables -A INPUT -p udp --dport 443 -j ACCEPT

# Дополнительные правила для защиты от DDoS-атак
sudo iptables -A INPUT -p tcp --dport 443 -m conntrack --ctstate NEW -m limit --limit 10/s --limit-burst 20 -j ACCEPT
sudo iptables -A INPUT -p udp --dport 443 -m conntrack --ctstate NEW -m limit --limit 10/s --limit-burst 20 -j ACCEPT
```

> **Примечание:**
> - Первые две команды разрешают входящие TCP и UDP подключения на порт 443, который используется Wstunnel для маскировки трафика WireGuard под обычный HTTPS-трафик
> - Последующие команды добавляют ограничения на новые подключения для защиты от DDoS-атак:
>   - `--limit 10/s` ограничивает скорость до 10 новых подключений в секунду
>   - `--limit-burst 20` позволяет короткие всплески активности до 20 подключений
>   - Это защищает сервер от перегрузки, отбрасывая чрезмерные попытки подключения
>
> Порт 443 (стандартный для HTTPS) выбран специально, чтобы трафик WireGuard выглядел как обычный защищенный веб-трафик, что затрудняет его обнаружение и блокировку.

## Дополнительные настройки и советы

### Защита от DDoS-атак

```bash
# Базовая защита от сканирования портов
sudo iptables -A INPUT -p tcp --tcp-flags ALL NONE -j DROP
sudo iptables -A INPUT -p tcp --tcp-flags SYN,FIN SYN,FIN -j DROP
sudo iptables -A INPUT -p tcp --tcp-flags SYN,RST SYN,RST -j DROP
sudo iptables -A INPUT -p tcp --tcp-flags FIN,RST FIN,RST -j DROP
sudo iptables -A INPUT -p tcp --tcp-flags ACK,FIN FIN -j DROP
sudo iptables -A INPUT -p tcp --tcp-flags ACK,URG URG -j DROP

# Ограничение количества новых соединений
sudo iptables -A INPUT -p tcp -m conntrack --ctstate NEW -m limit --limit 60/s --limit-burst 100 -j ACCEPT
sudo iptables -A INPUT -p tcp -m conntrack --ctstate NEW -j DROP
```

> **Примечание:** 
> - Первый блок команд защищает от нестандартных TCP-пакетов, используемых при сканировании портов и атаках. Комбинации флагов, указанные в правилах, не соответствуют нормальному TCP-соединению и часто используются для определения открытых портов или уязвимостей
> - Второй блок ограничивает количество новых TCP-подключений:
>   - Разрешает не более 60 новых соединений в секунду с пиковыми значениями до 100
>   - Все превышающие лимит новые подключения отбрасываются
>
> Эти правила защищают сервер от большинства автоматизированных атак и сканирования, значительно повышая безопасность.

### Обновление правил для различных сетевых интерфейсов

Если вы изменили имя сетевого интерфейса с современного формата (например, ens33) на классический (eth0), следует обновить правила файрвола:

```bash
sudo sed -i 's/ens33/eth0/g' /etc/iptables/rules.v4
```

> **Примечание:** Эта команда использует утилиту `sed` для поиска и замены всех вхождений строки `ens33` на `eth0` в файле `/etc/iptables/rules.v4`. Это необходимо, если вы переименовали сетевой интерфейс, как описано в [руководстве по изменению имен интерфейсов](1README_Change_Default_Network_Name_(ens33_ens3_ens18)_to_eth0.md). Без этого изменения правила файрвола могут не применяться к переименованному интерфейсу, что приведет к проблемам с сетевым соединением.

## Управление правилами файрвола

### Сохранение правил

```bash
sudo netfilter-persistent save
sudo netfilter-persistent reload
```

> **Примечание:** 
> - `netfilter-persistent save` сохраняет текущие правила iptables в файлы `/etc/iptables/rules.v4` и `/etc/iptables/rules.v6` 
> - `netfilter-persistent reload` перезагружает правила из этих файлов
> 
> Это позволяет сохранить настроенные правила файрвола, чтобы они автоматически применялись после перезагрузки системы.

Или в CentOS/RHEL:

```bash
sudo service iptables save
```

> **Примечание:** В дистрибутивах на базе RedHat (CentOS, RHEL) используется другой механизм сохранения правил файрвола. Команда `service iptables save` сохраняет текущие правила в файл конфигурации `/etc/sysconfig/iptables`, откуда они будут автоматически загружены при следующем запуске системы.

### Проверка текущих правил

```bash
sudo iptables -L -v
```

> **Примечание:** Команда отображает все текущие правила iptables в удобочитаемом формате:
> - `-L` (list) перечисляет все правила
> - `-v` (verbose) показывает детальную информацию, включая счетчики пакетов/байтов и интерфейсы
>
> Это полезно для проверки правильности настройки файрвола и диагностики проблем с соединением.

### Проверка правил с номерами строк

```bash
sudo iptables -L INPUT --line-numbers
```

> **Примечание:** Эта команда отображает правила в цепочке INPUT с номерами строк. Номера строк необходимы для последующего удаления или изменения конкретных правил. Параметр `--line-numbers` добавляет номер перед каждым правилом, что упрощает управление большим количеством правил.

### Удаление правила по номеру строки

```bash
sudo iptables -D INPUT номер_правила
```

> **Примечание:** Команда удаляет правило из цепочки INPUT по его номеру строки. Замените `номер_правила` на число, соответствующее номеру строки правила, которое вы хотите удалить. Номера строк можно узнать из вывода предыдущей команды с параметром `--line-numbers`.

### Проверка открытых портов

```bash
sudo ss -tulpn | grep -E '443|20820|10086|22'
```

> **Примечание:** Команда проверяет, какие порты прослушиваются системой:
> - `ss` - это современная замена команды `netstat`
> - `-t` показывает TCP-соединения
> - `-u` показывает UDP-соединения
> - `-l` отображает только прослушиваемые сокеты (открытые порты)
> - `-p` показывает процессы, связанные с сокетами
> - `-n` отображает номера портов вместо имен сервисов
> - `grep -E '443|20820|10086|22'` фильтрует результаты, показывая только порты, которые нас интересуют: 443 (HTTPS/Wstunnel), 20820 (WireGuard), 10086 (WGDashboard) и 22 (SSH)
>
> Эта команда помогает убедиться, что все необходимые сервисы правильно запущены и прослушивают соответствующие порты. 