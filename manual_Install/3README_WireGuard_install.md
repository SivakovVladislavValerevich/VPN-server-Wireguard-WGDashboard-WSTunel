# Пошаговое руководство по установке WireGuard на сервер

## Содержание

1. [Обзор](#обзор)
2. [Требования](#требования)
3. [Настройка WireGuard](#настройка-wireguard)
4. [Запуск и управление сервисом WireGuard](#запуск-и-управление-сервисом-wireguard)
5. [Настройка клиентов](#настройка-клиентов)
6. [Дополнительные команды](#дополнительные-команды)

## Обзор

WireGuard - современный, быстрый VPN-протокол с шифрованием на уровне ядра Linux. Он предлагает высокую производительность, низкую задержку и повышенную безопасность по сравнению с другими VPN-решениями.

## Требования

- Debian/Ubuntu или другой Linux-дистрибутив
- Права администратора (root)
- Открытый порт (по умолчанию 20820)
- Стабильное подключение к интернету
- Выполнение предварительных шагов из [Руководства по подготовке сервера к установкам и настройкам](0README_Preparing_the_server_for_installation_and_configuration.md) и [Руководства по настройке файрвола](2README_Configuring_The_Firewall.md)

> **Примечание**: Подготовка системы, обновление и установка необходимых пакетов описаны в [Руководстве по подготовке сервера к установкам и настройкам](0README_Preparing_the_server_for_installation_and_configuration.md). Настройка файрвола для дальнейшей работы и открытие необходимых портов описаны в [Руководстве по настройке файрвола](2README_Configuring_The_Firewall.md). Пожалуйста, выполните эти шаги перед продолжением установки WireGuard.

## Настройка WireGuard

### 1. Генерация ключей сервера

```bash
wg genkey | tee /etc/wireguard/privatekey | wg pubkey | tee /etc/wireguard/publickey
```

> **Примечание:** Эта команда создает пару криптографических ключей для WireGuard. Первая часть `wg genkey` генерирует приватный ключ, который передается через пайп (|) команде `tee /etc/wireguard/privatekey`, сохраняющей его в файл и одновременно передающей дальше. Затем `wg pubkey` создает соответствующий публичный ключ, который сохраняется в файл `/etc/wireguard/publickey`. Эти ключи используются для шифрования трафика и аутентификации соединений в WireGuard.

### 2. Установка прав доступа на приватный ключ

```bash
chmod 600 /etc/wireguard/privatekey
```

> **Примечание:** Команда `chmod 600` устанавливает права доступа на файл приватного ключа, ограничивая доступ к нему только для владельца (root). Числовое значение `600` означает, что владелец может читать и записывать файл (6=4+2), а группа и остальные пользователи не имеют никаких прав (0). Это важный шаг для обеспечения безопасности, так как приватный ключ должен быть защищен от несанкционированного доступа.

### 3. Создание конфигурационного файла сервера

```bash
nano /etc/wireguard/wg0.conf
```

> **Примечание:** Команда открывает текстовый редактор nano для создания или редактирования конфигурационного файла WireGuard. Файл `wg0.conf` содержит настройки для интерфейса WireGuard с именем wg0. В этом файле вы будете указывать приватный ключ, IP-адрес интерфейса, порт для прослушивания и правила маршрутизации трафика.

### 4. Содержание конфигурационного файла

Вставьте следующую конфигурацию в файл. По умолчанию используется сетевой интерфейс `eth0`:

```
[Interface]
PrivateKey = <privatekey>
Address = 10.0.0.1/24
ListenPort = 20820
PostUp = iptables -A FORWARD -i %i -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
PostDown = iptables -D FORWARD -i %i -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE
```

> **Примечание:** В этом конфигурационном файле:
> - `[Interface]` - начало секции настроек интерфейса WireGuard
> - `PrivateKey` - ваш приватный ключ (содержимое файла `/etc/wireguard/privatekey`)
> - `Address` - IP-адрес и маска подсети для вашего VPN-интерфейса (10.0.0.1/24 означает, что сервер получит адрес 10.0.0.1 в сети с маской 255.255.255.0)
> - `ListenPort` - порт, на котором WireGuard будет прослушивать входящие соединения
> - `PostUp` - команды, выполняемые после поднятия интерфейса: настройка перенаправления трафика между VPN и интернетом
> - `PostDown` - команды, выполняемые при отключении интерфейса: удаление правил маршрутизации
> - `%i` - подстановочный знак, который заменяется на имя интерфейса (wg0)
> - Команды iptables настраивают NAT (маскарадинг) для преобразования адресов между VPN-сетью и интернетом

Замените `<privatekey>` на содержимое файла `/etc/wireguard/privatekey` (команда для просмотра содержимого файла `/etc/wireguard/privatekey`: `nano /etc/wireguard/privatekey`)

> **Важно** поменять стандартный порт WG - 51820 на свой, т.к. первый критерий, но далеко не единственный, по которому РКН и провы по его указке блочат WG именно он!
> Если у вас на серваке Linux, то простое добавление в конфиг строки:
> `ListenPort = 20820`
> ничего не даст, т.к. надо обязательно поменять его в основном конфиге:
> `wg-quick`
> полный путь:
> `/usr/bin/wg-quick` (команда: `nano /usr/bin/wg-quick`)
> место в конфиге, где поменять порт:
> ```
> HAVE_SET_FIREWALL=0
> add_default() {
>     local table line
>     if ! get_fwmark table; then
>         table=51820
> ```
> Меняете 51820 на свой (20820).

### 5. Настройка IP-форвардинга

Для работы WireGuard как VPN-сервера необходимо включить IP-форвардинг. Подробные инструкции см. в [руководстве по настройке файрвола](2README_Configuring_the_firewall.md).

## Запуск и управление сервисом WireGuard

### 1. Включение и запуск сервиса WireGuard

```bash
systemctl enable wg-quick@wg0.service
systemctl start wg-quick@wg0.service
```

> **Примечание:** Эти две команды активируют и запускают сервис WireGuard:
> - `systemctl enable wg-quick@wg0.service` - настраивает автоматический запуск интерфейса wg0 при загрузке системы
> - `systemctl start wg-quick@wg0.service` - немедленно запускает сервис WireGuard
> 
> Имя `wg0` в командах соответствует имени файла конфигурации `/etc/wireguard/wg0.conf`. Если вы создали конфигурационный файл с другим именем, например `wg1.conf`, то нужно использовать соответствующее имя сервиса: `wg-quick@wg1.service`.

### 2. Проверка статуса сервиса

```bash
systemctl status wg-quick@wg0.service
```

> **Примечание:** Эта команда проверяет текущий статус сервиса WireGuard. Она отображает информацию о том, запущен ли сервис, когда он был запущен, использование ресурсов и последние записи журнала. Статус "active (running)" означает, что сервис успешно запущен и работает. Если вы видите ошибки или статус "failed", проверьте конфигурацию и журналы системы для поиска причины проблемы.

## Последующие действия не обязательны для выполнения, ведь настройку клиентов делаем через веб-панель WGDashoard после полной установки настройки!

## Настройка клиентов 

Для подключения клиентов к серверу WireGuard необходимо:

1. Сгенерировать ключевую пару для каждого клиента
2. Добавить конфигурацию клиента в файл на сервере
3. Создать конфигурационный файл клиента

### Пример добавления клиента на сервере

На сервере добавьте в конец файла /etc/wireguard/wg0.conf:

```bash
[Peer]
PublicKey = <публичный ключ клиента>
AllowedIPs = 10.0.0.2/32
```

> **Примечание:** Этот блок конфигурации добавляет нового клиента (пира) в конфигурацию сервера:
> - `[Peer]` - начало секции настроек для клиента
> - `PublicKey` - публичный ключ клиента, который вы генерируете на устройстве клиента
> - `AllowedIPs` - IP-адреса, которые будут назначены клиенту в VPN-сети. Значение `10.0.0.2/32` означает, что клиенту назначается единственный IP-адрес 10.0.0.2. При добавлении новых клиентов используйте последовательные адреса (10.0.0.3/32, 10.0.0.4/32 и т.д.)
>
> Эта конфигурация определяет, какие клиенты могут подключаться к серверу и какие IP-адреса им назначаются.

После добавления клиента необходимо перезапустить сервис:

```bash
systemctl restart wg-quick@wg0.service
```

> **Примечание:** Команда перезапускает сервис WireGuard, чтобы применить изменения в конфигурационном файле. Это действие временно разрывает все активные VPN-соединения, но они быстро восстанавливаются после перезапуска сервиса. Перезапуск необходим всякий раз, когда вы вносите изменения в файл конфигурации `/etc/wireguard/wg0.conf`.

## Дополнительные команды

### Проверка статуса соединений

```bash
wg show
```

> **Примечание:** Команда `wg show` отображает текущее состояние всех интерфейсов WireGuard, включая:
> - Публичный ключ сервера
> - Порт прослушивания
> - Список подключенных пиров с их публичными ключами
> - Разрешенные IP-адреса для каждого пира
> - Последнюю активность и объем переданных данных
>
> Эта команда полезна для мониторинга активных подключений и проверки корректности работы VPN.

### Перезапуск сервиса WireGuard

```bash
systemctl restart wg-quick@wg0.service
```

> **Примечание:** Эта команда перезапускает сервис WireGuard интерфейса wg0. Перезапуск требуется после внесения изменений в конфигурационный файл (добавление/удаление клиентов, изменение настроек и т.д.). Во время перезапуска все активные VPN-соединения будут временно прерваны, а затем автоматически восстановлены с новыми настройками. 