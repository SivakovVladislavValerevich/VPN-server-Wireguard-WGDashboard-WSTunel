# Руководство по обфускации трафика WireGuard через Wstunnel

## Содержание

1. [Обзор](#обзор)
2. [Требования](#требования)
3. [Установка Wstunnel на сервере](#установка-wstunnel-на-сервере)
4. [Настройка сервера](#настройка-сервера)
5. [Настройка файрвола](#настройка-файрвола)
6. [Настройка клиентов](#настройка-клиентов)
   - [Android клиент](#android-клиент)
   - [Windows клиент](#windows-клиент)
   - [Linux клиент](#linux-клиент)
7. [Устранение проблем](#устранение-проблем)

## Обзор

WireGuard является отличным решением для создания безопасной VPN-сети или для доступа к заблокированным сайтам и приложениям. Однако протокол может быть легко заблокирован. В некоторых местах блокировка может быть временной или постоянной. Как обойти блокировку протокола WireGuard? На помощь приходят веб-сокеты! Мы будем использовать Wstunnel для обертывания всего сетевого трафика WireGuard в WebSockets, что сделает его более устойчивым к блокировкам.

В этом руководстве содержатся инструкции по настройке Wstunnel на вашем сервере WireGuard и на различных клиентских операционных системах: Android, Windows и Linux.

## Требования

- Настроенный и работающий сервер WireGuard
- Права администратора на сервере
- Доступ к порту 443 (или другому выбранному порту) на вашем сервере
- Выполнение предварительных шагов из [0README_Preparing_the_server_for_installation_and_configuration.md](0README_Preparing_the_server_for_installation_and_configuration.md) и [Руководства по настройке файрвола](2README_Configuring_The_Firewall.md)

> **Примечание**: Подготовка системы, обновление и установка необходимых пакетов описаны в [0README_Preparing_the_server_for_installation_and_configuration.md](0README_Preparing_the_server_for_installation_and_configuration.md). Настройка файрвола для дальнейшей работы и открытие необходимых портов описаны в [Руководстве по настройке файрвола](2README_Configuring_The_Firewall.md). Пожалуйста, выполните эти шаги перед продолжением настройки обфускации трафика.

**Терминология для примеров:**
- Публичный IP вашего сервера: 203.0.113.1 (вам нужно заменить его своим IP)
- Порт WireGuard: 20820 (проверьте свой порт с помощью команды `sudo wg show all listen-port`)

## Установка Wstunnel на сервере

Подключитесь к вашему серверу через SSH.

### Метод 1: Скачивание конкретной версии Wstunnel

Загрузите последнюю версию Wstunnel с GitHub:

```bash
cd ~ && curl -fLo wstunnel.tar.gz https://github.com/erebe/wstunnel/releases/download/v10.1.9/wstunnel_10.1.9_linux_amd64.tar.gz
```

> **Примечание:** Эта команда выполняет два действия: сначала переходит в домашнюю директорию пользователя (`cd ~`), затем загружает архив с Wstunnel версии 10.1.9 для 64-битной Linux системы. Параметры `curl` означают: 
> - `-f` (fail) - прерывать скачивание при ошибке сервера
> - `-L` (location) - следовать за перенаправлениями
> - `-o wstunnel.tar.gz` - сохранить файл с указанным именем
> 
> Архив содержит скомпилированный бинарный файл wstunnel, который будет использоваться для туннелирования трафика WireGuard через WebSockets.

### Метод 2: Автоматическое определение последней версии

Для автоматического определения и загрузки последней версии Wstunnel выполните:

```bash
latest="$(curl -sI https://github.com/erebe/wstunnel/releases/latest | tr -d '\r' | grep '^location:')" \
&& latest="${latest##*/v}" \
&& curl -fLo wstunnel.tar.gz "https://github.com/erebe/wstunnel/releases/download/v${latest}/wstunnel_${latest}_linux_amd64.tar.gz"
```

> **Примечание:** Этот сложный скрипт автоматически определяет и скачивает самую последнюю версию Wstunnel:
> 1. `curl -sI` отправляет HEAD-запрос для получения только заголовков
> 2. `tr -d '\r'` удаляет символы возврата каретки
> 3. `grep '^location:'` находит строку с URL перенаправления на последнюю версию
> 4. `latest="${latest##*/v}"` извлекает номер версии из URL
> 5. Последняя команда `curl` загружает актуальную версию Wstunnel с использованием полученного номера версии
>
> Этот метод гарантирует, что вы всегда устанавливаете самую свежую версию программы с актуальными исправлениями и улучшениями.

> Вы можете заменить `amd64` в команде на нужную архитектуру.

### Установка бинарного файла

Извлеките бинарный файл из архива:

```bash
tar -xzf wstunnel.tar.gz wstunnel
```

> **Примечание:** Команда `tar` распаковывает архив:
> - `-x` (extract) - извлечение файлов
> - `-z` - работа с gzip-сжатием
> - `-f wstunnel.tar.gz` - имя архива
> - `wstunnel` - имя файла для извлечения (только этот файл, а не весь архив)
>
> Эта команда извлекает только исполняемый файл wstunnel из загруженного архива.

Добавьте права на выполнение:

```bash
chmod +x wstunnel
```

> **Примечание:** Команда `chmod +x` добавляет право на выполнение (executable) для файла wstunnel. Без этого шага файл не может быть запущен как программа. Право на выполнение необходимо, чтобы система могла распознать файл как исполняемую программу.

Установите Wstunnel в системную директорию:

```bash
sudo mv wstunnel /usr/local/bin
```

> **Примечание:** Команда перемещает исполняемый файл wstunnel в директорию `/usr/local/bin`, которая входит в стандартный путь поиска исполняемых файлов (PATH). После этого wstunnel можно будет запускать из любой директории, просто набрав команду `wstunnel`, без указания полного пути к файлу.

Проверьте успешность установки:

```bash
wstunnel --version
```

> **Примечание:** Команда проверяет, правильно ли установлен Wstunnel, выводя информацию о его версии. Если команда выполнится успешно, значит установка прошла корректно и программа доступна в системе. Если вы получаете ошибку "command not found", проверьте, была ли команда `mv` выполнена успешно и есть ли директория `/usr/local/bin` в вашем PATH.

Настройте возможность привязки к порту 443 без прав root:

```bash
sudo setcap cap_net_bind_service=+ep /usr/local/bin/wstunnel
```

> **Примечание:** Команда `setcap` устанавливает расширенные возможности (capabilities) для бинарного файла wstunnel:
> - `cap_net_bind_service=+ep` разрешает программе привязываться к привилегированным портам (ниже 1024, включая порт 443)
> - `+ep` означает, что возможность эффективна (+e) и постоянна (+p)
>
> Это позволяет запускать wstunnel на порту 443 (стандартный HTTPS) без необходимости запуска от имени пользователя root, что повышает безопасность системы.

> **Примечание:** Если вам потребуется обновить wstunnel в будущем, просто повторите шаги установки.

## Настройка сервера

Вам не нужно менять настройки WireGuard на вашем сервере. Достаточно запустить wstunnel, который будет прослушивать входящий трафик и перенаправлять его на WireGuard.

### Шаг 1: Создание секретного ключа

Сгенерируйте секретный ключ для защиты Wstunnel сервера:

```bash
openssl rand -base64 42
```

> **Примечание:** Эта команда генерирует случайный секретный ключ, который будет использоваться для дополнительной защиты соединения Wstunnel:
> - `openssl` - набор инструментов для криптографических операций
> - `rand` - генерация случайных данных
> - `-base64` - кодирование результата в Base64 формат (текстовое представление бинарных данных)
> - `42` - количество байт случайных данных для генерации
>
> Полученный ключ будет использоваться как секретный префикс пути для WebSocket-соединений, что обеспечит дополнительный уровень защиты от автоматического сканирования и обнаружения вашего сервера Wstunnel. Этот ключ нужно сохранить в надежном месте, так как он потребуется для настройки клиентов.

Сохраните полученную строку, она понадобится для настройки клиентов.

### Шаг 2: Тестовый запуск Wstunnel

Для первоначального тестирования вы можете запустить сервер в фоновом режиме с выводом в консоль:

```bash
wstunnel server --restrict-http-upgrade-path-prefix "<secret>" --restrict-to localhost:20820 wss://0.0.0.0:443
```

> **Примечание:** Эта команда запускает Wstunnel в режиме сервера с определенными параметрами:
> - `server` - указывает, что программа запускается в режиме сервера
> - `--restrict-http-upgrade-path-prefix "<secret>"` - устанавливает секретный префикс пути, который клиенты должны использовать для подключения (замените `<secret>` на сгенерированный ранее ключ)
> - `--restrict-to localhost:20820` - разрешает перенаправление трафика только на локальный порт 20820, где работает сервер WireGuard
> - `wss://0.0.0.0:443` - указывает, что сервер должен слушать входящие WebSocket-соединения через защищенный протокол WSS (WebSocket Secure) на всех сетевых интерфейсах (`0.0.0.0`) на порту 443 (стандартный порт HTTPS)
>
> В этой конфигурации wstunnel работает как мост между внешними WSS-соединениями и локальным UDP-портом WireGuard, маскируя VPN-трафик под обычный защищенный веб-трафик.

> Где:
> - `<secret>` - это ваш секретный ключ, сгенерированный на предыдущем шаге
> - `20820` - порт, на котором работает ваш WireGuard сервер (проверьте его с помощью команды `sudo wg show all listen-port`)
> - `443` - порт для прослушивания веб-сокетов (если у вас уже запущен веб-сервер на этом порту, выберите другой)

> Этот режим запуска временный и прекратится при закрытии сессии SSH. Для постоянной работы необходимо создать системную службу.

### Шаг 3: Создание системной службы

Создайте отдельного пользователя для сервиса Wstunnel:

```bash
sudo useradd --system --shell /usr/sbin/nologin wstunnel
```

> **Примечание:** Эта команда создает системного пользователя `wstunnel`:
> - `--system` - указывает, что пользователь создается для системной службы, а не для человека
> - `--shell /usr/sbin/nologin` - устанавливает для пользователя специальную оболочку, которая запрещает вход в систему
>
> Создание отдельного пользователя с ограниченными правами повышает безопасность системы: даже если в программе Wstunnel обнаружится уязвимость, злоумышленник получит доступ только к правам этого ограниченного пользователя.

Создайте файл службы systemd:

```bash
sudo nano /etc/systemd/system/wstunnel.service
```

> **Примечание:** Команда открывает текстовый редактор nano для создания нового файла службы systemd. Systemd - это система инициализации и управления службами в современных Linux-системах. Файл, который вы создаете, будет содержать конфигурацию, необходимую для автоматического управления службой Wstunnel (запуск при загрузке системы, автоматический перезапуск при сбоях и т.д.).

Вставьте следующую конфигурацию (замените `<secret>` на ваш секретный ключ и убедитесь, что порт 20820 соответствует порту вашего WireGuard сервера): 

```ini
[Unit]
Description=Wstunnel for WireGuard
After=network-online.target
Wants=network-online.target

[Service]
User=wstunnel
Type=exec
ExecStart=/usr/local/bin/wstunnel server --restrict-http-upgrade-path-prefix "<secret>" --restrict-to localhost:20820 wss://0.0.0.0:443
Restart=on-failure

[Install]
WantedBy=multi-user.target
```

> **Примечание:** Конфигурационный файл службы systemd состоит из нескольких секций:
> - `[Unit]` содержит общую информацию и зависимости:
>   - `Description` - человекочитаемое описание службы
>   - `After=network-online.target` - указывает, что служба должна запускаться только после того, как сеть станет доступна
>   - `Wants=network-online.target` - указывает на зависимость от сетевого соединения
> - `[Service]` определяет, как запускается и управляется служба:
>   - `User=wstunnel` - служба будет запускаться от имени пользователя wstunnel
>   - `Type=exec` - тип службы - простая исполняемая программа
>   - `ExecStart` - полная команда для запуска программы
>   - `Restart=on-failure` - автоматически перезапускать службу при сбоях
> - `[Install]` определяет, как служба интегрируется в систему:
>   - `WantedBy=multi-user.target` - служба будет запускаться при загрузке системы в многопользовательском режиме

> Пояснения:
> - Директива `ExecStart` задаёт команду запуска wstunnel, которую мы описали выше
> - `Restart` используется для автоматического перезапуска сервера в случае сбоя
> - Секция `[Install]` используется для автоматического запуска службы при загрузке системы

### Шаг 4: Запуск и настройка автозапуска службы

```bash
sudo systemctl start wstunnel && sudo systemctl enable wstunnel
```

> **Примечание:** Эта команда состоит из двух частей, объединенных оператором `&&` (выполнить вторую команду только если первая успешно завершилась):
> - `sudo systemctl start wstunnel` - непосредственно запускает службу Wstunnel, которая начнет прослушивать порт 443 и перенаправлять трафик на порт WireGuard
> - `sudo systemctl enable wstunnel` - настраивает систему для автоматического запуска службы при загрузке сервера
> 
> После выполнения этих команд служба Wstunnel будет работать постоянно, даже после перезагрузки сервера. Это обеспечивает стабильное функционирование системы обфускации трафика без необходимости ручного вмешательства при каждом перезапуске.

### Шаг 5: Проверка статуса службы

```bash
sudo systemctl status wstunnel
```

> **Примечание:** Команда проверяет текущее состояние службы Wstunnel. Вывод команды содержит:
> - Статус службы (active/inactive/failed)
> - Время запуска и продолжительность работы
> - PID (идентификатор процесса)
> - Используемые ресурсы (память, CPU)
> - Последние строки лога службы
> 
> В нормальном состоянии вы должны увидеть статус `active (running)` и сообщения без ошибок. Если вы видите ошибки или состояние `failed`, проверьте конфигурацию в файле `/etc/systemd/system/wstunnel.service` и логи системы с помощью команды `journalctl -u wstunnel`.

Вы должны увидеть сообщение о том, что сервис активен и работает.

## Настройка файрвола

Для корректной работы Wstunnel необходимо настроить файрвол для разрешения входящих подключений на порт 443 (или другой выбранный). Подробные инструкции по настройке файрвола для всех компонентов системы, включая Wstunnel, можно найти в [руководстве по настройке файрвола](2README_Configuring_the_firewall.md).

После настройки файрвола проверьте открытые порты с помощью команды:

```bash
sudo ss -tulpn | grep -E '443|20820'
```

> **Примечание по проверке портов:** Если вы видите, что порт 443 активен (состояние LISTEN) с процессом "wstunnel", но порт 20820 показан только в состоянии UNCONN как на примере ниже, это нормально:
>
> ```
> udp    UNCONN 0      0                 0.0.0.0:20820         0.0.0.0:*
> udp    UNCONN 0      0                    [::]:20820            [::]:*
> tcp    LISTEN 0      1024              0.0.0.0:443           0.0.0.0:*      users:(("wstunnel",pid=704,fd=9))
> ```
>
> Для UDP-протоколов (который использует WireGuard) состояние UNCONN является нормальным, так как UDP — протокол без установления соединения. Главное, что порт открыт в файрволе.
>
> Если же порт 20820 вообще не отображается в выводе, проверьте следующее:
>
> 1. Проверьте статус WireGuard:
>    ```bash
>    sudo systemctl status wg-quick@wg0.service
>    ```
>
> 2. Перезапустите службу WireGuard:
>    ```bash
>    sudo systemctl restart wg-quick@wg0.service
>    ```
>
> 3. Убедитесь, что в конфигурации WireGuard указан правильный порт:
>    ```bash
>    sudo cat /etc/wireguard/wg0.conf | grep ListenPort
>    ```

## Настройка клиентов

На каждом клиентском устройстве необходимо запустить Wstunnel-клиент, который будет действовать как локальный WireGuard-сервер и туннелировать трафик на реальный сервер. Базовая команда для запуска Wstunnel-клиента выглядит следующим образом:

```bash
wstunnel client --http-upgrade-path-prefix "<secret>" -L "udp://20820:localhost:20820?timeout_sec=0" wss://203.0.113.1:443
```

> Где:
> - `<secret>` - это секретный ключ, который вы настроили на сервере
> - `20820` - порт, используемый WireGuard
> - `203.0.113.1` - IP-адрес вашего сервера (замените на свой)
> - `443` - порт, на котором работает Wstunnel на сервере

Далее рассмотрим настройку для каждой операционной системы.

### Android клиент

#### Предварительные требования:
- Установленное приложение WireGuard
- Установленный терминальный эмулятор (Termux или TermOne Plus)

#### Вариант 1: Настройка с помощью Termux:

1. Установите Termux из Google Play или F-Droid
2. Запустите Termux и выполните:

```bash
apt update && apt upgrade -y
apt install wget -y
curl -fLo wstunnel.tar.gz https://github.com/erebe/wstunnel/releases/download/v10.1.9/wstunnel_10.1.9_android_arm64.tar.gz
tar -xzf wstunnel.tar.gz wstunnel
chmod 777 wstunnel
```

3. Создайте скрипт для запуска туннеля (замените `<secret>` и IP-адрес на свои):

```bash
echo './wstunnel client --http-upgrade-path-prefix "<secret>" -L "udp://20820:localhost:20820?timeout_sec=0" wss://203.0.113.1:443' > tunnel
```

4. Запустите скрипт:

```bash
sh tunnel
```

Вы должны увидеть примерно такой вывод:
```
2024-08-29 INFO wstunnel::protocols::udp::server: Starting UDP server listening cnx on 127.0.0.1:20820 with cnx timeout of 0s
```

#### Вариант 2: Настройка с помощью TermOne Plus:

1. Установите TermOne Plus из Google Play
2. Есть два метода установки бинарного файла wstunnel на ваше устройство:

   a. Если на вашем устройстве есть команды `curl` и `tar`:
   ```bash
   cd ~ \
   && curl -Lo wstunnel.tar.gz https://github.com/erebe/wstunnel/releases/download/v10.1.9/wstunnel_10.1.9_linux_arm64.tar.gz \
   && tar -xzf wstunnel.tar.gz wstunnel
   ```
   
   b. Если команды отсутствуют:
   - Скачайте бинарный файл на ПК
   - Скопируйте его в корневую директорию хранилища устройства
   - Откройте TermOne и дайте ему разрешения на доступ к файлам
   - Выполните:
   ```bash
   cd ~ && cp /sdcard/wstunnel .
   ```

3. Добавьте права на выполнение:
```bash
chmod 777 wstunnel
```

4. Создайте и запустите скрипт туннеля так же, как в варианте с Termux.

5. Для удобства можно настроить автоматический запуск wstunnel:
   - Откройте меню TermOne
   - Перейдите в Preferences / Shell / Initial command
   - Измените `cd ~` на `cd ~ && sh tunnel`

#### Настройка приложения WireGuard:

1. Откройте приложение WireGuard и выберите свой VPN-профиль
2. Нажмите на иконку карандаша для редактирования
3. Измените Endpoint на `127.0.0.1:20820`
4. Рассчитайте новые разрешенные IP-адреса:
   - Используйте калькулятор AllowedIPs в браузере
   - Введите `0.0.0.0/0` в поле Allowed IPs
   - Введите IP-адрес вашего сервера в поле Disallowed IPs
   - Скопируйте результат и вставьте в поле Allowed IPs
5. Сохраните изменения и включите профиль

После подключения вернитесь к терминалу и проверьте логи. Вы должны увидеть сообщение о новом UDP-соединении и успешном TLS-рукопожатии:

```
2024-08-29 INFO wstunnel::protocols::udp::server: New UDP connection from 127.0.0.1:59571
2024-08-29 INFO wstunnel::protocols::tcp::server: Opening TCP connection to 203.0.113.1:443
2024-08-29 INFO wstunnel::protocols::tls::server: Doing TLS handshake using SNI IpAddress(V4(Ipv4Addr([203, 0, 113, 1]))) with the server 203.0.113.1:443
2024-08-29 INFO tunnel{id="..." remote="localhost:20820"}: wstunnel::tunnel::transport::websocket: received frame Ping
2024-08-29 INFO tunnel{id="..." remote="localhost:20820"}: wstunnel::tunnel::transport::websocket: received frame Pong
```

Проверьте доступ в интернет – всё должно работать.

### Windows клиент

1. Скачайте бинарный файл Wstunnel для Windows:

```powershell
mkdir ~\wstunnel
cd ~\wstunnel
curl.exe -fLo wstunnel.tar.gz https://github.com/erebe/wstunnel/releases/download/v10.1.9/wstunnel_10.1.9_windows_amd64.tar.gz
tar -xzf wstunnel.tar.gz wstunnel.exe
```

2. Добавьте путь к директории wstunnel в системную переменную PATH:
   - Нажмите Win+R, введите `sysdm.cpl` и нажмите Enter
   - Перейдите на вкладку "Дополнительно" и нажмите "Переменные среды"
   - В разделе "Системные переменные" найдите и выберите Path
   - Нажмите "Изменить", затем "Создать"
   - Введите путь к директории wstunnel (используйте команду `pwd` в PowerShell для определения полного пути)
   - Нажмите OK во всех окнах для сохранения изменений

3. Проверьте, что wstunnel успешно установлен, открыв новое окно PowerShell и выполнив:
```powershell
./wstunnel --version
```

4. Разрешите выполнение скриптов в конфигурации WireGuard:

```powershell
reg add HKLM\Software\WireGuard /v DangerousScriptExecution /t REG_DWORD /d 1 /f
```

5. Настройте конфигурацию WireGuard:
   - Откройте WireGuard и выберите туннель для редактирования
   - Измените Endpoint на `127.0.0.1:20820`
   - Добавьте следующие команды в секцию [Interface] (замените IP-адреса и секрет на свои):

```
PostUp = route add 203.0.113.1 mask 255.255.255.255 192.168.1.1 && start "" wstunnel client --http-upgrade-path-prefix "<secret>" -L "udp://20820:localhost:20820?timeout_sec=0" wss://203.0.113.1:443
PostDown = route delete 203.0.113.1 mask 255.255.255.255 192.168.1.1 && powershell -command "(Get-Process -Name wstunnel).Kill()"
```

> Примечания:
> - `203.0.113.1` - IP-адрес вашего сервера
> - `192.168.1.1` - IP-адрес вашего маршрутизатора (для правильной маршрутизации трафика)
> - `<secret>` - секретный ключ, настроенный на сервере
> - `20820` - порт WireGuard

6. Важно: Снимите флажок "Блокировать нетуннелированный трафик" (Block untunneled traffic) 

7. Сохраните изменения и активируйте VPN

Вот как выглядит полная конфигурация туннеля в WireGuard:

```
[Interface]
PrivateKey = your_private_key_here
Address = 10.0.0.2/24
DNS = 1.1.1.1, 8.8.8.8
PostUp = route add 203.0.113.1 mask 255.255.255.255 192.168.1.1 && start "" wstunnel client --http-upgrade-path-prefix "<secret>" -L "udp://20820:localhost:20820?timeout_sec=0" wss://203.0.113.1:443
PostDown = route delete 203.0.113.1 mask 255.255.255.255 192.168.1.1 && powershell -command "(Get-Process -Name wstunnel).Kill()"

[Peer]
PublicKey = your_server_public_key_here
AllowedIPs = 0.0.0.0/1, 128.0.0.0/1
Endpoint = 127.0.0.1:20820
```

После активации VPN, команда PostUp:
1. Добавит маршрут к вашему серверу через маршрутизатор (это необходимо для обхода туннеля при подключении непосредственно к серверу)
2. Запустит wstunnel для перенаправления трафика WireGuard через WebSocket

При отключении VPN, команда PostDown:
1. Удалит добавленный маршрут
2. Завершит процесс wstunnel

### Linux клиент

1. Установите Wstunnel на клиент, следуя инструкциям из раздела "Установка Wstunnel на сервере"

2. Отредактируйте конфигурацию WireGuard:

```bash
sudo nano /etc/wireguard/wg0.conf
```

3. Измените параметр Endpoint в секции [Peer]:

```
Endpoint = 127.0.0.1:20820
```

4. Добавьте команды PostUp и PostDown в секцию [Interface] (замените IP-адреса и секрет на свои):

```
PostUp = ip route add 203.0.113.1/32 via 192.168.1.1
PostUp = wstunnel client --http-upgrade-path-prefix "<secret>" -L "udp://20820:localhost:20820?timeout_sec=0" wss://203.0.113.1:443 &> /dev/null &
PostDown = ip route del 203.0.113.1/32 via 192.168.1.1
PostDown = killall wstunnel
```

> Примечания:
> - `203.0.113.1` - IP-адрес вашего сервера
> - `192.168.1.1` - IP-адрес вашего маршрутизатора
> - `<secret>` - секретный ключ, настроенный на сервере
> - `20820` - порт WireGuard

5. Примените изменения:

```bash
wg-quick down wg0
wg-quick up wg0
```

6. Проверьте подключение:

```bash
curl -4 https://ip.hetzner.com
```

Результат должен показать IP-адрес вашего VPN-сервера (203.0.113.1).

## Устранение проблем

### Проблемы с запуском Wstunnel

Если возникают проблемы с запуском Wstunnel, проверьте:

1. Логи службы:

```bash
sudo journalctl -u wstunnel -f
```

2. Статус службы:

```bash
sudo systemctl status wstunnel
```

### Порт 443 уже занят

Если порт 443 уже используется веб-сервером, выберите другой порт для Wstunnel и измените настройки соответственно как на сервере, так и на клиентах.

### Проверка маршрутизации трафика

Чтобы убедиться, что трафик идет через туннель:

```bash
curl -4 https://ip.hetzner.com
```

Результат должен показать IP-адрес вашего VPN-сервера.

### Проблемы с обходом блокировок

Если обфускация через WebSocket не работает, попробуйте следующее:

1. Смените порт с 443 на другой стандартный порт (например, 80, 8080)
2. Проверьте, не блокирует ли ваш провайдер WebSocket соединения
3. Дополнительно настройте SNI для обхода DPI

### Проверка работоспособности Wstunnel

Для проверки работоспособности соединения на стороне клиента запустите Wstunnel с флагом `--verbose`:

```bash
wstunnel client --http-upgrade-path-prefix "<secret>" -L "udp://20820:localhost:20820?timeout_sec=0" wss://203.0.113.1:443 --verbose
```

> Это поможет увидеть подробные логи соединения и выявить возможные проблемы.

### Диагностика проблем с маршрутизацией

Если у вас возникают проблемы с маршрутизацией (трафик не идет через VPN), проверьте текущие маршруты:

```bash
# На Linux
ip route

# На Windows
route print
```

Убедитесь, что маршрут к вашему серверу добавлен правильно и не перехватывается туннелем.

## Заключение

Благодаря использованию Wstunnel и WebSockets, вы смогли обойти блокировку протокола WireGuard и сделать ваш VPN более надежным. Существуют и другие варианты для обфускации трафика VPN, например udp2raw, но они могут требовать root-прав на клиентских устройствах. 